- project:
    name: ovsdb-full-integration
    jobs:
        - 'ovsdb-daily-full-integration-{stream}'

    # stream:    release stream (eg. stable-lithium or beryllium)
    # branch:    git branch (eg. stable/lithium or master)
    stream:
        - boron:
            branch: 'master'
            jdk: openjdk8
            jdks:
                - openjdk8
        - beryllium:
            branch: 'stable/beryllium'
            jdk: openjdk8
            jdks:
                - openjdk8
        - stable-lithium:
            branch: 'stable/lithium'
            jdk: openjdk7
            jdks:
                - openjdk7

    project: 'ovsdb'
    archive-artifacts: '*.log'

- job-template:
    name: 'ovsdb-daily-full-integration-{stream}'

    # Required Variables:
    #     stream:    release stream (eg. stable-lithium or beryllium)
    #     branch:    git branch (eg. stable/lithium or master)

    project-type: matrix
    node: matrix_master
    description: 'Integration tests for the OVSDB project against different versions of OVS and branches. This job runs nightly. '
    execution-strategy:
        sequential: true

    axes:
        - axis:
            type: user-defined
            name: 'OVS_VERSION'
            values:
                - 2.3.3
                - 2.4.0
                - 2.5.0
        - axis:
            type: jdk
            values: '{obj:jdks}'

        - axis:
            type: slave
            name: nodes
            values:
                - centos7-docker-2c-4g

    logrotate:
        daysToKeep: '{build-days-to-keep}'
        numToKeep: '{build-num-to-keep}'
        artifactDaysToKeep: '{build-artifact-days-to-keep}'
        artifactNumToKeep: '{build-artifact-num-to-keep}'

    parameters:
        - opendaylight-infra-parameters:
            project: '{project}'
            branch: '{branch}'
            refspec: 'refs/heads/{branch}'
            artifacts: '{archive-artifacts}'

    scm:
        - gerrit-trigger-scm:
            refspec: '$GERRIT_REFSPEC'
            branch: '{branch}'
            choosing-strategy: gerrit

    wrappers:
        - opendaylight-infra-wrappers:
            build-timeout: '{build-timeout}'

    triggers:
        - timed: '@midnight'
        - gerrit:
            server-name: 'OpenDaylight'
            trigger-on:
              - comment-added-contains-event:
                 comment-contains-value: 'runit'
            projects:
              - project-compare-type: 'ANT'
                project-pattern: '{project}'
                branches:
                  - branch-compare-type: 'ANT'
                    branch-pattern: '**/{branch}'
            skip-vote:
                successful: true
                failed: true
                unstable: true
                notbuilt: true

    builders:
        - wipe-org-opendaylight-repo
        - shell:
            !include-raw-escape:
                - include-raw-setup-docker.sh
        - inject:
            properties-file: env.properties
        - maven-target:
            maven-version: '{mvn33}'
            pom: 'pom.xml'
            goals: '-V -B -l build.log clean install dependency:tree -Pq -Dmaven.compile.fork=true'
            properties:
                - 'maven.repo.local=/tmp/r'
                - 'org.ops4j.pax.url.mvn.localRepository=/tmp/r'
                - 'stream={stream}'
            java-opts:
                - '-Xmx1024m -XX:MaxPermSize=256m'
            settings: 'ovsdb-settings'
            settings-type: cfp
            global-settings: 'odl-global-settings'
            global-settings-type: cfp
        - maven-target:
            maven-version: '{mvn33}'
            pom: 'southbound/southbound-it/pom.xml'
            goals: '-V -B verify -l southboundIT.log -Pintegrationtest -Dskip.karaf.featureTest=true -Dmaven.compile.fork=true -Dovsdb.controller.address=${{CONTROLLER_IP}}'
            properties:
                - 'ovsdbserver.ipaddress=127.0.0.1'
                - 'ovsdbserver.port=6641'
                - 'ovsdb.userspace.enabled=yes'
                - 'maven.repo.local=/tmp/r'
                - 'org.ops4j.pax.url.mvn.localRepository=/tmp/r'
                - 'stream={stream}'
            java-opts:
                - '-Xmx1024m -XX:MaxPermSize=256m'
            settings: 'ovsdb-settings'
            settings-type: cfp
            global-settings: 'odl-global-settings'
            global-settings-type: cfp
        - shell:
            !include-raw-escape:
                - include-setup-hwvtep-docker.sh
        - maven-target:
            maven-version: '{mvn33}'
            pom: 'library/it/pom.xml'
            goals: '-V -B verify -l libraryIT.log -Pintegrationtest -Dskip.karaf.featureTest=true -Dmaven.compile.fork=true -Dovsdb.controller.address=${{CONTROLLER_IP}}'
            properties:
                - 'ovsdbserver.ipaddress=127.0.0.1'
                - 'ovsdbserver.port=6641'
                - 'ovsdb.userspace.enabled=yes'
                - 'maven.repo.local=/tmp/r'
                - 'org.ops4j.pax.url.mvn.localRepository=/tmp/r'
                - 'stream={stream}'
            java-opts:
                - '-Xmx1024m -XX:MaxPermSize=256m'
            settings: 'ovsdb-settings'
            settings-type: cfp
            global-settings: 'odl-global-settings'
            global-settings-type: cfp
        - maven-target:
            maven-version: '{mvn33}'
            pom: 'hwvtepsouthbound/hwvtepsouthbound-it/pom.xml'
            goals: '-V -B verify -l hwvtepsouthboundIT.log -Pintegrationtest -Dskip.karaf.featureTest=true -Dmaven.compile.fork=true -Dovsdb.controller.address=${{CONTROLLER_IP}}'
            properties:
                - 'ovsdbserver.ipaddress=127.0.0.1'
                - 'ovsdbserver.port=6641'
                - 'ovsdb.userspace.enabled=yes'
                - 'maven.repo.local=/tmp/r'
                - 'org.ops4j.pax.url.mvn.localRepository=/tmp/r'
                - 'stream={stream}'
            java-opts:
                - '-Xmx1024m -XX:MaxPermSize=256m'
            settings: 'ovsdb-settings'
            settings-type: cfp
            global-settings: 'odl-global-settings'
            global-settings-type: cfp

        - shell:
            !include-raw-escape:
                - include-raw-cleanup-docker.sh
        - jacoco-nojava-workaround

    publishers:
        - email-notification:
            email-prefix: '[ovsdb]'
        - archive-build:
            maven-version: '{mvn33}'
