# Macros for the AutoRelease project
- parameter:
    name: autorelease-release-tag
    parameters:
        - string:
            name: RELEASE_TAG
            default: '{release-tag}'
            description: "The Release train tag to use eg. Helium-SR3"

- parameter:
    name: autorelease-release-branch
    parameters:
        - string:
            name: RELEASE_BRANCH
            default: '{release-branch}'
            description: "The Release train branch to base build off eg. stable/helium"

- parameter:
    name: autorelease-release-datestamp
    parameters:
        - bool:
            name: DATESTAMP
            default: '{datestamp}'
            description: "Whether to include a datestamp or not"

- wrapper:
    name: autorelease-build-timeout
    wrappers:
        - timeout:
            type: absolute
            timeout: 720
            fail: true

- trigger:
    name: autorelease-trigger-patch-site-merged
    triggers:
        - gerrit:
            server-name: 'OpenDaylight'
            trigger-on:
                - change-merged-event
                - comment-added-contains-event:
                    comment-contains-value: 'republish'
            projects:
              - project-compare-type: 'ANT'
                project-pattern: '{name}'
                branches:
                    - branch-compare-type: 'ANT'
                      branch-pattern: '**/{branch}'
                file-paths:
                    - compare-type: ANT
                      pattern: src/site/**
                    - compare-type: ANT
                      pattern: site.xml

- trigger:
    name: autorelease-trigger-patch-site-submitted
    triggers:
        - gerrit:
            server-name: 'OpenDaylight'
            trigger-on:
                - patchset-created-event:
                    exclude-drafts: 'false'
                    exclude-trivial-rebase: 'false'
                    exclude-no-code-change: 'false'
                - draft-published-event
                - comment-added-contains-event:
                    comment-contains-value: 'recheck'
                - comment-added-contains-event:
                    comment-contains-value: 'reverify'
            projects:
              - project-compare-type: 'ANT'
                project-pattern: '{name}'
                branches:
                  - branch-compare-type: 'ANT'
                    branch-pattern: '**/{branch}'
                file-paths:
                    - compare-type: ANT
                      pattern: src/site/**
                    - compare-type: ANT
                      pattern: site.xml

- builder:
    name: autorelease-checkout-gerrit-patch
    builders:
        - shell: |
            cd ${GERRIT_PROJECT}
            echo "Checking out ${GERRIT_PROJECT} patch ${GERRIT_REFSPEC}..."
            git fetch origin ${GERRIT_REFSPEC} && git checkout FETCH_HEAD
            cd ..

- builder:
    name: autorelease-cfp
    builders:
        - config-file-provider:
            files:
                - file-id: '{autorelease-settings}'
                  variable: 'AUTORELEASE_SETTINGS'
                - file-id: '{odl-global-settings}'
                  variable: 'ODL_GLOBAL_SETTINGS'

- builder:
    name: autorelease-maven-deploy
    builders:
        - shell: !include-raw include-raw-autorelease-maven-deploy.sh

- builder:
    name: autorelease-maven-sources
    builders:
        - maven-target:
            maven-version: '{maven-version}'
            pom: 'pom.xml'
            goals: 'dependency:sources -DoutputFile=$WORKSPACE/sources.log -DappendOutput -Dmaven.repo.local=/tmp/r -Dorg.ops4j.pax.url.mvn.localRepository=/tmp/r'
            java-opts:
                - '-Xmx4096m -XX:MaxPermSize=1024m'
            settings: '{settings}'
            global-settings: '{global-settings}'

- builder:
    name: autorelease-maven-sources-post-process
    builders:
        - shell: |
            awk '/The following files have NOT been resolved:/,/^$/' sources.log > missing-sources.log

- builder:
    name: autorelease-generate-taglist
    builders:
        - shell: |
            git submodule foreach 'echo $path `git rev-parse --verify HEAD` ${RELEASE_TAG} >> ../taglist.log'

- builder:
    name: autorelease-generate-release-patches
    builders:
        - shell:
            !include-raw-escape include-raw-autorelease-release-versions.sh

- builder:
    name: autorelease-sys-stats
    builders:
        - shell: |
            uname -a
            df -h

- builder:
    name: autorelease-get-integration-test-variables
    builders:
    - shell: !include-raw include-raw-autorelease-get-integration-test-variables.sh

- builder:
    name: autorelease-generate-project-report
    builders:
    - shell: !include-raw include-raw-generate-project-report.sh
