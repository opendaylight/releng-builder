---
- project:
    name: netvirt-job-reports
    project: netvirt
    jobs:
      - netvirt-job-reports
    report-numjobs: 30
    report-jobnames: >
        netvirt-csit-1node-0cmb-1ctl-2cmp-openstack-queens-upstream-stateful-fluorine
        netvirt-csit-1node-0cmb-1ctl-2cmp-openstack-queens-upstream-stateful-snat-conntrack-fluorine
        netvirt-csit-1node-0cmb-1ctl-2cmp-openstack-queens-upstream-stateful-oxygen
        netvirt-csit-1node-0cmb-1ctl-2cmp-openstack-queens-upstream-stateful-snat-conntrack-oxygen
    report-path: '/tmp/jobreports'
    report-logurl: 'https://logs.opendaylight.org/releng/vex-yul-odl-jenkins-1'

- job-template:
    name: '{prefix}netvirt-job-reports'
    id: netvirt-job-reports
    node: centos7-builder-2c-8g
    project-type: freestyle
    disabled: false

    properties:
      - opendaylight-infra-properties:
          build-days-to-keep: '{build-days-to-keep}'

    parameters:
      - opendaylight-infra-parameters:
          os-cloud: '{os-cloud}'
          project: '{project}'
          branch: '{branch}'
          refspec: 'refs/heads/{branch}'
          artifacts: '{archive-artifacts}'
      - string:
          name: JOBNAMES
          default: '{report-jobnames}'
          description: |
              Space separated list of job names to process. Example:
              netvirt-csit-1node-0cmb-1ctl-2cmp-openstack-queens-upstream-stateful-fluorine
              netvirt-csit-1node-0cmb-1ctl-2cmp-openstack-queens-upstream-stateful-snat-conntrack-fluorine
      - string:
          name: NUMJOBS
          default: '{report-numjobs}'
          description: 'Number of jobs to process'
      - string:
          name: REPORTPATH
          default: '{report-path}'
          description: 'Output path to write files'
      - string:
          name: LOGURL
          default: '{report-logurl}'
          description: 'Logs url'

    wrappers:
      - opendaylight-infra-wrappers:
          build-timeout: '{build-timeout}'

    builders:
      - run-job-reports

    triggers:
      - timed: '@daily'

    publishers:
      - lf-infra-publish

- builder:
    name: run-job-reports
    builders:
      - shell: |
          #!/bin/bash
          echo "Executing run-job-reports"
          set -x  # Debug script
          set +e  # Do Not fail script if command returns non-zero.
          virtualenv $WORKSPACE/venv
          source $WORKSPACE/venv/bin/activate
          PYTHON="$WORKSPACE/venv/bin/python"
          $PYTHON -m pip install --upgrade pip
          $PYTHON -m pip install odltools
          mkdir $REPORTPATH
          $PYTHON -m odltools csit reports --numjobs $NUMJOBS --path $REPORTPATH --url $LOGURL --jobnames $JOBNAMES
          mkdir -p $WORKSPACE/archives
          cp $REPORTPATH/*.txt $WORKSPACE/archives
          exit 0
