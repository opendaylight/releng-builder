---
- project:
    name: builder-jobs
    jobs:
      - '{project-name}-ci-jobs'
      - builder-check-poms
      - builder-copy-sandbox-logs
      - gerrit-tox-verify
      # OpenStack Related
      - 'builder-verify-image-protection'
      - 'builder-cleanup-old-images'
      - 'builder-delete-orphaned-nodes'
      - 'builder-delete-stale-nodes'
      - 'builder-delete-stale-stacks'
      # Automation for docs and jobs
      - 'builder-update-image-list'

    # The following values are only specified here
    # so that code blocks look similar to other projects.
    project: 'releng/builder'
    project-name: builder
    stream: master
    branch: master
    build-node: centos7-builder-2c-1g
    archive-artifacts: '**/*.log'
    build-timeout: 30
    jjb-version: 2.0.0

- project:
    name: packer-jobs
    # packer jobs templates are defined in global-jjb
    jobs:
      - '{project-name}-packer-jobs'
    project: 'releng/builder'
    project-name: builder
    branch: master
    archive-artifacts: '**/*.log'
    build-node: centos7-builder-2c-1g

    platforms:
      - centos
      - ubuntu-14.04
      - ubuntu-16.04

    templates:
      - devstack
      - devstack-pre-pip-newton:
          build-timeout: 75
      - devstack-pre-pip-ocata:
          build-timeout: 60
      - devstack-pre-pip-pike:
          build-timeout: 75
      - gbp
      - mininet-ovs-2.5:
          build-timeout: 60
      - mininet-ovs-2.6:
          build-timeout: 75

    exclude:
      - platforms: centos
        templates: gbp
      - platforms: centos
        templates: mininet-ovs-2.5
      - platforms: centos
        templates: mininet-ovs-2.6
      - platforms: ubuntu-14.04
        templates: devstack-pre-pip-newton
      - platforms: ubuntu-14.04
        templates: devstack-pre-pip-ocata
      - platforms: ubuntu-14.04
        templates: devstack-pre-pip-pike
      - platforms: ubuntu-14.04
        templates: devstack
      - platforms: ubuntu-14.04
        templates: mininet-ovs-2.5
      - platforms: ubuntu-14.04
        templates: mininet-ovs-2.6
      - platforms: ubuntu-16.04
        templates: devstack-pre-pip-newton
      - platforms: ubuntu-16.04
        templates: devstack-pre-pip-ocata
      - platforms: ubuntu-16.04
        templates: devstack-pre-pip-pike
      - platforms: ubuntu-16.04
        templates: devstack

- job-template:
    name: builder-check-poms
    node: centos7-builder-2c-1g

    project-type: freestyle

    properties:
      - opendaylight-infra-properties:
          build-days-to-keep: 14

    parameters:
      - opendaylight-infra-parameters:
          os-cloud: '{os-cloud}'
          project: '{project}'
          branch: '{branch}'
          refspec: 'refs/heads/{branch}'
          artifacts: '{archive-artifacts}'

    wrappers:
      - opendaylight-infra-wrappers:
          build-timeout: '{build-timeout}'

    triggers:
      - timed: 'H H * * 1'

    builders:
      - shell: !include-raw-escape: check-poms.sh

    publishers:
      - email-notification:
          email-recipients: '{email-recipients}'
          email-prefix: '[releng]'
      - lf-infra-publish

- job-template:
    name: builder-copy-sandbox-logs
    node: centos7-builder-2c-1g

    project-type: freestyle

    properties:
      - opendaylight-infra-properties:
          build-days-to-keep: 1

    parameters:
      - opendaylight-infra-parameters:
          os-cloud: ''
          project: ''
          branch: ''
          refspec: ''
          artifacts: ''

    wrappers:
      - opendaylight-infra-wrappers:
          build-timeout: 10

    triggers:
      - gerrit:
          server-name: '{gerrit-server-name}'
          trigger-on:
            - comment-added-contains-event:
                comment-contains-value: 'copy-logs:'
          projects:
            - project-compare-type: ANT
              project-pattern: '**'
              branches:
                - branch-compare-type: ANT
                  branch-pattern: '**'

    builders:
      - shell: !include-raw-escape: copy-sandbox-logs.sh

    publishers:
      - lf-infra-publish


- job-template:
    name: 'builder-verify-image-protection'
    project-type: freestyle
    node: centos7-builder-2c-1g

    properties:
      - opendaylight-infra-properties:
          build-days-to-keep: 7

    parameters:
      - opendaylight-infra-parameters:
          os-cloud: '{os-cloud}'
          project: '{project}'
          branch: '{branch}'
          refspec: 'refs/heads/{branch}'
          artifacts: '{archive-artifacts}'

    scm:
      - git-scm:
          branch: '{branch}'

    wrappers:
      - opendaylight-infra-wrappers:
          build-timeout: '{build-timeout}'
      # Listed after to override openstack-infra-wrappers clouds.yaml definition
      - config-file-provider:
          files:
            - file-id: clouds-yaml
              target: '$HOME/.config/openstack/clouds.yaml'

    triggers:
      - timed: '@daily'

    builders:
      - shell: !include-raw-escape:
          - opendaylight-infra-check-image-protection.sh

    publishers:
      - email-notification:
          email-recipients: '{email-recipients}'
          email-prefix: '[releng]'
      - lf-infra-publish


- job-template:
    name: 'builder-cleanup-old-images'
    project-type: freestyle
    node: centos7-builder-2c-1g

    properties:
      - opendaylight-infra-properties:
          build-days-to-keep: 7

    parameters:
      - opendaylight-infra-parameters:
          os-cloud: '{os-cloud}'
          project: '{project}'
          branch: '{branch}'
          refspec: 'refs/heads/{branch}'
          artifacts: '{archive-artifacts}'

    scm:
      - git-scm:
          branch: '{branch}'

    wrappers:
      - opendaylight-infra-wrappers:
          build-timeout: '{build-timeout}'
      # Listed after to override openstack-infra-wrappers clouds.yaml definition
      - config-file-provider:
          files:
            - file-id: clouds-yaml
              target: '$HOME/.config/openstack/clouds.yaml'

    triggers:
      # Cleanup images on a weekly schedule
      - timed: '@weekly'

    builders:
      - shell: !include-raw-escape:
          - global-jjb/shell/lftools-install.sh
          - opendaylight-infra-cleanup-old-images.sh

    publishers:
      - email-notification:
          email-recipients: '{email-recipients}'
          email-prefix: '[releng]'
      - lf-infra-publish


- job-template:
    name: builder-delete-orphaned-nodes
    project-type: freestyle
    node: centos7-builder-2c-1g

    properties:
      - opendaylight-infra-properties:
          build-days-to-keep: 7

    parameters:
      - opendaylight-infra-parameters:
          os-cloud: '{os-cloud}'
          project: '{project}'
          branch: '{branch}'
          refspec: 'refs/heads/{branch}'
          artifacts: '{archive-artifacts}'
      - string:
          name: JENKINS_URLS
          default: 'https://jenkins.opendaylight.org/releng https://jenkins.opendaylight.org/sandbox'
          description: 'Space separated list of Jenkins URLs to check for active builds'

    wrappers:
      - opendaylight-infra-wrappers:
          build-timeout: '{build-timeout}'

    triggers:
      # Attempt to clear up servers every 30 mins in case we have orphaned servers
      - timed: '0,30 * * * *'

    builders:
      - shell: !include-raw-escape: opendaylight-infra-cleanup-orphaned-nodes.sh

    publishers:
      - email-notification:
          email-recipients: '{email-recipients}'
          email-prefix: '[releng]'
      - lf-infra-publish


- job-template:
    name: 'builder-delete-stale-nodes'
    project-type: freestyle
    node: centos7-builder-2c-1g

    properties:
      - opendaylight-infra-properties:
          build-days-to-keep: 7

    parameters:
      - opendaylight-infra-parameters:
          os-cloud: '{os-cloud}'
          project: '{project}'
          branch: '{branch}'
          refspec: 'refs/heads/{branch}'
          artifacts: '{archive-artifacts}'

    wrappers:
      - opendaylight-infra-wrappers:
          build-timeout: '{build-timeout}'

    triggers:
      # Attempt to clear up stacks every 30 mins in case we have orphaned stacks
      - timed: '0,30 * * * *'

    builders:
      - shell: !include-raw-escape:
          - global-jjb/shell/lftools-install.sh
          - opendaylight-infra-cleanup-stale-nodes.sh

    publishers:
      - email-notification:
          email-recipients: '{email-recipients}'
          email-prefix: '[releng]'
      - lf-infra-publish


- job-template:
    name: 'builder-delete-stale-stacks'
    project-type: freestyle
    node: centos7-builder-2c-1g

    properties:
      - opendaylight-infra-properties:
          build-days-to-keep: 7

    parameters:
      - opendaylight-infra-parameters:
          os-cloud: '{os-cloud}'
          project: '{project}'
          branch: '{branch}'
          refspec: 'refs/heads/{branch}'
          artifacts: '{archive-artifacts}'
      - string:
          name: JENKINS_URLS
          default: 'https://jenkins.opendaylight.org/releng https://jenkins.opendaylight.org/sandbox'
          description: 'Space separated list of Jenkins URLs to check for active builds'

    wrappers:
      - opendaylight-infra-wrappers:
          build-timeout: '{build-timeout}'

    triggers:
      # Attempt to clear up stacks every 30 mins in case we have orphaned stacks
      - timed: '0,30 * * * *'

    builders:
      - shell: !include-raw-escape: opendaylight-infra-cleanup-stale-stacks.sh

    publishers:
      - email-notification:
          email-recipients: '{email-recipients}'
          email-prefix: '[releng]'
      - lf-infra-publish


- job-template:
    name: 'builder-update-image-list'
    project-type: freestyle
    node: centos7-builder-2c-1g

    properties:
      - opendaylight-infra-properties:
          build-days-to-keep: 7

    parameters:
      - opendaylight-infra-parameters:
          os-cloud: vex
          project: '{project}'
          branch: '{branch}'
          refspec: 'refs/heads/{branch}'
          artifacts: '{archive-artifacts}'

    scm:
      - git-scm:
          branch: '{branch}'

    wrappers:
      - opendaylight-infra-wrappers:
          build-timeout: '{build-timeout}'
      # Listed after to override openstack-infra-wrappers clouds.yaml definition
      - config-file-provider:
          files:
            - file-id: clouds-yaml
              target: '$HOME/.config/openstack/clouds.yaml'

    triggers:
      # Update image list every Monday to Friday at 11:00 UTC
      - timed: '0 11 * * 1-5'

    builders:
      - shell: !include-raw-escape: opendaylight-infra-update-image-list.sh
      - opendaylight-infra-push-gerrit-patch:
          project: '{project}'
          gerrit-topic: 'releng-update-cloud-image-list'
          gerrit-commit-message: 'Update cloud image list docs'

    publishers:
      - email-notification:
          email-recipients: '{email-recipients}'
          email-prefix: '[releng]'
      - lf-infra-publish
