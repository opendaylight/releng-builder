---
# SPDX-License-Identifier: Apache-2.0
# Gerrit-triggered Packer build workflow (redesigned for per-type jobs)
# This workflow builds Packer images when:
# 1. Changes are merged from Gerrit (workflow_dispatch)
# 2. Monthly scheduled builds (1st of every month)
#
# Architecture: Separate jobs per builder type with sequential dependencies
# - Prevents OpenStack quota exhaustion during scheduled builds
# - Allows selective rebuilds based on file changes
# - Matches JJB pattern with separate jobs per type

name: Gerrit Packer Merge

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
    inputs:
      GERRIT_BRANCH:
        description: "Branch that change is against"
        required: true
        type: string
      GERRIT_CHANGE_ID:
        description: "The ID for the change"
        required: true
        type: string
      GERRIT_CHANGE_NUMBER:
        description: "The Gerrit number"
        required: true
        type: string
      GERRIT_CHANGE_URL:
        description: "URL to the change"
        required: true
        type: string
      GERRIT_EVENT_TYPE:
        description: "Type of Gerrit event"
        required: true
        type: string
      GERRIT_PATCHSET_NUMBER:
        description: "The patch number for the change"
        required: true
        type: string
      GERRIT_PATCHSET_REVISION:
        description: "The revision sha"
        required: true
        type: string
      GERRIT_PROJECT:
        description: "Project in Gerrit"
        required: true
        type: string
      GERRIT_REFSPEC:
        description: "Gerrit refspec of change"
        required: true
        type: string
      PACKER_BUILDS:
        description: "Build selection: 'all', 'builder,docker' or 'builder:centos-7,docker:ubuntu-22.04'"
        required: false
        type: string
        default: ""

  schedule:
    # Run on 1st of every month at 00:00 UTC
    - cron: "0 0 1 * *"

concurrency:
  group: packer-build-${{ inputs.GERRIT_CHANGE_ID || github.run_id }}
  cancel-in-progress: false

jobs:
  clear-vote:
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'schedule' &&
      inputs.GERRIT_CHANGE_NUMBER != '' &&
      inputs.GERRIT_CHANGE_NUMBER != '0'
    steps:
      - name: Clear votes
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/gerrit-review-action@6d2e00dfd3173cd9a36d11350c8fba44731c7b4e # v0.10.0
        with:
          host: ${{ vars.GERRIT_SERVER }}
          username: ${{ vars.GERRIT_SSH_USER }}
          key: ${{ secrets.GERRIT_SSH_PRIVKEY_B64 }}
          known_hosts: ${{ vars.GERRIT_KNOWN_HOSTS }}
          change-number: ${{ inputs.GERRIT_CHANGE_NUMBER }}
          gerrit-label: Verified
          score: 0
          comment-message: "Packer builds started"

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # Change detection flags
      builder_changed: ${{ steps.filter.outputs.builder }}
      docker_changed: ${{ steps.filter.outputs.docker }}
      robot_changed: ${{ steps.filter.outputs.robot }}
      helm_changed: ${{ steps.filter.outputs.helm }}
      mininet_changed: ${{ steps.filter.outputs.mininet }}
      # Platform matrices
      builder_platforms: ${{ steps.matrices.outputs.builder_platforms }}
      docker_platforms: ${{ steps.matrices.outputs.docker_platforms }}
      robot_platforms: ${{ steps.matrices.outputs.robot_platforms }}
      helm_platforms: ${{ steps.matrices.outputs.helm_platforms }}
      mininet_platforms: ${{ steps.matrices.outputs.mininet_platforms }}
      # Build control
      build_mode: ${{ steps.build_mode.outputs.mode }}
    steps:
      - name: Determine build mode
        id: build_mode
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "mode=scheduled" >> "$GITHUB_OUTPUT"
            echo "ðŸ“… Scheduled monthly build - building all types"
          elif [[ "${{ inputs.PACKER_BUILDS }}" == "all" ]] || [[ -n "${{ inputs.PACKER_BUILDS }}" ]]; then
            echo "mode=manual" >> "$GITHUB_OUTPUT"
            echo "ðŸ”¨ Manual build selection: ${{ inputs.PACKER_BUILDS }}"
          else
            echo "mode=change-detect" >> "$GITHUB_OUTPUT"
            echo "ðŸ” Change detection mode"
          fi

      - name: Checkout change
        if: github.event_name != 'schedule'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/checkout-gerrit-change-action@54d751e8bd167bc91f7d665dabe33fae87aaaa63 # v0.9
        with:
          gerrit-refspec: ${{ inputs.GERRIT_REFSPEC }}
          delay: "10s"
          submodules: "true"

      - name: Checkout repository (scheduled)
        if: github.event_name == 'schedule'
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.repository.default_branch }}
          submodules: true

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Check for packer file changes
        id: filter
        # yamllint disable-line rule:line-length
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            builder:
              - 'packer/templates/builder.pkr.hcl'
              - 'packer/common-packer/templates/builder.pkr.hcl'
              - 'packer/provision/builder/**'
              - 'packer/provision/baseline.sh'
              - 'packer/provision/system-reseal.sh'
              - 'packer/common-packer/vars/*.pkrvars.hcl'
            docker:
              - 'packer/templates/docker.pkr.hcl'
              - 'packer/common-packer/templates/docker.pkr.hcl'
              - 'packer/provision/docker/**'
              - 'packer/provision/baseline.sh'
              - 'packer/provision/system-reseal.sh'
              - 'packer/common-packer/vars/centos-7.pkrvars.hcl'
              - 'packer/common-packer/vars/ubuntu-20.04.pkrvars.hcl'
              - 'packer/common-packer/vars/ubuntu-22.04.pkrvars.hcl'
              - 'packer/common-packer/vars/ubuntu-25.04.pkrvars.hcl'
            robot:
              - 'packer/templates/robot.pkr.hcl'
              - 'packer/provision/robot/**'
              - 'packer/provision/baseline.sh'
              - 'packer/provision/system-reseal.sh'
              - 'packer/common-packer/vars/centos-7.pkrvars.hcl'
              - 'packer/common-packer/vars/centos-cs-8.pkrvars.hcl'
              - 'packer/common-packer/vars/centos-cs-9.pkrvars.hcl'
              - 'packer/common-packer/vars/ubuntu-22.04.pkrvars.hcl'
              - 'packer/common-packer/vars/ubuntu-24.04.pkrvars.hcl'
            helm:
              - 'packer/templates/helm.pkr.hcl'
              - 'packer/provision/helm/**'
              - 'packer/provision/baseline.sh'
              - 'packer/provision/system-reseal.sh'
              - 'packer/common-packer/vars/centos-7.pkrvars.hcl'
            mininet:
              - 'packer/templates/mininet-ovs-217.pkr.hcl'
              - 'packer/provision/mininet-ovs-217/**'
              - 'packer/provision/baseline.sh'
              - 'packer/provision/system-reseal.sh'
              - 'packer/common-packer/vars/ubuntu-22.04.pkrvars.hcl'
              - 'packer/common-packer/vars/ubuntu-24.04.pkrvars.hcl'

      - name: Generate platform matrices
        id: matrices
        run: |
          BUILD_MODE="${{ steps.build_mode.outputs.mode }}"
          PACKER_BUILDS="${{ inputs.PACKER_BUILDS }}"

          # Define all platforms per type
          # builder: all platforms
          BUILDER_ALL='["centos-7","centos-cs-8","centos-cs-9","ubuntu-20.04","ubuntu-22.04","ubuntu-24.04","ubuntu-25.04"]'
          # docker: only these platforms
          DOCKER_ALL='["centos-7","ubuntu-20.04","ubuntu-22.04","ubuntu-25.04"]'
          # robot: centos + ubuntu 22.04, 24.04
          ROBOT_ALL='["centos-7","centos-cs-8","centos-cs-9","ubuntu-22.04","ubuntu-24.04"]'
          # helm: only centos-7
          HELM_ALL='["centos-7"]'
          # mininet: only ubuntu 22.04, 24.04
          MININET_ALL='["ubuntu-22.04","ubuntu-24.04"]'

          if [[ "$BUILD_MODE" == "scheduled" ]]; then
            # Scheduled build: build everything
            {
              echo "builder_platforms=$BUILDER_ALL"
              echo "docker_platforms=$DOCKER_ALL"
              echo "robot_platforms=$ROBOT_ALL"
              echo "helm_platforms=$HELM_ALL"
              echo "mininet_platforms=$MININET_ALL"
            } >> "$GITHUB_OUTPUT"
          elif [[ "$BUILD_MODE" == "manual" ]]; then
            # Manual build: parse PACKER_BUILDS input
            # Format: "all" or "builder,docker" or "builder:centos-7,docker:ubuntu-22.04"
            if [[ "$PACKER_BUILDS" == "all" ]]; then
              {
                echo "builder_platforms=$BUILDER_ALL"
                echo "docker_platforms=$DOCKER_ALL"
                echo "robot_platforms=$ROBOT_ALL"
                echo "helm_platforms=$HELM_ALL"
                echo "mininet_platforms=$MININET_ALL"
              } >> "$GITHUB_OUTPUT"
            else
              # Parse custom specification
              BUILDER_MATRIX='[]'
              DOCKER_MATRIX='[]'
              ROBOT_MATRIX='[]'
              HELM_MATRIX='[]'
              MININET_MATRIX='[]'

              IFS=',' read -ra SPECS <<< "$PACKER_BUILDS"
              for spec in "${SPECS[@]}"; do
                if [[ "$spec" == *":"* ]]; then
                  # template:platform format
                  template="${spec%:*}"
                  platform="${spec#*:}"
                  case "$template" in
                    builder) BUILDER_MATRIX=$(jq -c ". += [\"$platform\"]" <<< "$BUILDER_MATRIX") ;;
                    docker) DOCKER_MATRIX=$(jq -c ". += [\"$platform\"]" <<< "$DOCKER_MATRIX") ;;
                    robot) ROBOT_MATRIX=$(jq -c ". += [\"$platform\"]" <<< "$ROBOT_MATRIX") ;;
                    helm) HELM_MATRIX=$(jq -c ". += [\"$platform\"]" <<< "$HELM_MATRIX") ;;
                    mininet-ovs-217|mininet) MININET_MATRIX=$(jq -c ". += [\"$platform\"]" <<< "$MININET_MATRIX") ;;
                  esac
                else
                  # Just template name - use all platforms for that type
                  case "$spec" in
                    builder) BUILDER_MATRIX="$BUILDER_ALL" ;;
                    docker) DOCKER_MATRIX="$DOCKER_ALL" ;;
                    robot) ROBOT_MATRIX="$ROBOT_ALL" ;;
                    helm) HELM_MATRIX="$HELM_ALL" ;;
                    mininet-ovs-217|mininet) MININET_MATRIX="$MININET_ALL" ;;
                  esac
                fi
              done

              {
                echo "builder_platforms=$BUILDER_MATRIX"
                echo "docker_platforms=$DOCKER_MATRIX"
                echo "robot_platforms=$ROBOT_MATRIX"
                echo "helm_platforms=$HELM_MATRIX"
                echo "mininet_platforms=$MININET_MATRIX"
              } >> "$GITHUB_OUTPUT"
            fi
          else
            # Change detection mode: use paths-filter results
            if [[ "${{ steps.filter.outputs.builder }}" == "true" ]]; then
              echo "builder_platforms=$BUILDER_ALL" >> "$GITHUB_OUTPUT"
            else
              echo "builder_platforms=[]" >> "$GITHUB_OUTPUT"
            fi

            if [[ "${{ steps.filter.outputs.docker }}" == "true" ]]; then
              echo "docker_platforms=$DOCKER_ALL" >> "$GITHUB_OUTPUT"
            else
              echo "docker_platforms=[]" >> "$GITHUB_OUTPUT"
            fi

            if [[ "${{ steps.filter.outputs.robot }}" == "true" ]]; then
              echo "robot_platforms=$ROBOT_ALL" >> "$GITHUB_OUTPUT"
            else
              echo "robot_platforms=[]" >> "$GITHUB_OUTPUT"
            fi

            if [[ "${{ steps.filter.outputs.helm }}" == "true" ]]; then
              echo "helm_platforms=$HELM_ALL" >> "$GITHUB_OUTPUT"
            else
              echo "helm_platforms=[]" >> "$GITHUB_OUTPUT"
            fi

            if [[ "${{ steps.filter.outputs.mininet }}" == "true" ]]; then
              echo "mininet_platforms=$MININET_ALL" >> "$GITHUB_OUTPUT"
            else
              echo "mininet_platforms=[]" >> "$GITHUB_OUTPUT"
            fi
          fi

          echo ""
          echo "â„¹ï¸ Platform matrices generated (see job outputs for details)"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Build Jobs - One per builder type
  # Sequential execution for scheduled builds (quota control)
  # Parallel execution for manual/merge builds (speed)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  build-builder:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.builder_platforms != '[]' &&
      (needs.detect-changes.outputs.builder_changed == 'true' ||
       needs.detect-changes.outputs.build_mode == 'scheduled' ||
       needs.detect-changes.outputs.build_mode == 'manual')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # Scheduled: 2 concurrent (quota control)
      # Manual/Merge: 5 concurrent (speed)
      max-parallel: ${{ needs.detect-changes.outputs.build_mode == 'scheduled' && 2 || 5 }}
      matrix:
        platform: ${{ fromJson(needs.detect-changes.outputs.builder_platforms) }}
    steps:
      - name: Checkout change
        if: github.event_name != 'schedule'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/checkout-gerrit-change-action@54d751e8bd167bc91f7d665dabe33fae87aaaa63 # v0.9
        with:
          gerrit-refspec: ${{ inputs.GERRIT_REFSPEC }}
          delay: "0s"
          submodules: "true"

      - name: Checkout repository (scheduled)
        if: github.event_name == 'schedule'
        # yamllint disable-line rule:line-length
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.repository.default_branch }}
          submodules: true

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Setup OpenStack + Tailscale Bastion
        id: bastion-setup
        # yamllint disable-line rule:line-length
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: setup
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}
          tailscale_oauth_client_id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          tailscale_oauth_secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          bastion_flavor: "v3-standard-2"
          bastion_image: "Ubuntu 22.04.5 LTS (x86_64) [2025-03-27]"
          debug_mode: "false"

      - name: Build Packer Image
        id: build
        uses: askb/packer-build-action@main
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          mode: build
          packer_template: "packer/templates/builder.pkr.hcl"
          packer_vars_file: "packer/common-packer/vars/${{ matrix.platform }}.pkrvars.hcl"
          packer_working_dir: "packer"
          packer_version: "1.9.1"
          path_prefix: "${{ github.workspace }}"
          bastion_ip: ${{ steps.bastion-setup.outputs.bastion_ip }}
          bastion_ssh_user: "ubuntu"
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}

      - name: Teardown OpenStack Bastion
        if: always()
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: teardown
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}

  build-docker:
    needs: [detect-changes, build-builder]
    # Sequential dependency for scheduled builds (quota control)
    # Use always() to run even if builder was skipped
    if: |
      always() &&
      needs.detect-changes.outputs.docker_platforms != '[]' &&
      (needs.detect-changes.outputs.docker_changed == 'true' ||
       needs.detect-changes.outputs.build_mode == 'scheduled' ||
       needs.detect-changes.outputs.build_mode == 'manual')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: ${{ needs.detect-changes.outputs.build_mode == 'scheduled' && 2 || 5 }}
      matrix:
        platform: ${{ fromJson(needs.detect-changes.outputs.docker_platforms) }}
    steps:
      - name: Checkout change
        if: github.event_name != 'schedule'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/checkout-gerrit-change-action@54d751e8bd167bc91f7d665dabe33fae87aaaa63 # v0.9
        with:
          gerrit-refspec: ${{ inputs.GERRIT_REFSPEC }}
          delay: "0s"
          submodules: "true"

      - name: Checkout repository (scheduled)
        if: github.event_name == 'schedule'
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.repository.default_branch }}
          submodules: true

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Setup OpenStack + Tailscale Bastion
        id: bastion-setup
        # yamllint disable-line rule:line-length
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: setup
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}
          tailscale_oauth_client_id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          tailscale_oauth_secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          bastion_flavor: "v3-standard-2"
          bastion_image: "Ubuntu 22.04.5 LTS (x86_64) [2025-03-27]"
          debug_mode: "false"

      - name: Build Packer Image
        id: build
        uses: askb/packer-build-action@main
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          mode: build
          packer_template: "packer/templates/docker.pkr.hcl"
          packer_vars_file: "packer/common-packer/vars/${{ matrix.platform }}.pkrvars.hcl"
          packer_working_dir: "packer"
          packer_version: "1.9.1"
          path_prefix: "${{ github.workspace }}"
          bastion_ip: ${{ steps.bastion-setup.outputs.bastion_ip }}
          bastion_ssh_user: "ubuntu"
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}

      - name: Teardown OpenStack Bastion
        if: always()
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: teardown
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}

  build-robot:
    needs: [detect-changes, build-docker]
    if: |
      always() &&
      needs.detect-changes.outputs.robot_platforms != '[]' &&
      (needs.detect-changes.outputs.robot_changed == 'true' ||
       needs.detect-changes.outputs.build_mode == 'scheduled' ||
       needs.detect-changes.outputs.build_mode == 'manual')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: ${{ needs.detect-changes.outputs.build_mode == 'scheduled' && 2 || 5 }}
      matrix:
        platform: ${{ fromJson(needs.detect-changes.outputs.robot_platforms) }}
    steps:
      - name: Checkout change
        if: github.event_name != 'schedule'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/checkout-gerrit-change-action@54d751e8bd167bc91f7d665dabe33fae87aaaa63 # v0.9
        with:
          gerrit-refspec: ${{ inputs.GERRIT_REFSPEC }}
          delay: "0s"
          submodules: "true"

      - name: Checkout repository (scheduled)
        if: github.event_name == 'schedule'
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.repository.default_branch }}
          submodules: true

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Setup OpenStack + Tailscale Bastion
        id: bastion-setup
        # yamllint disable-line rule:line-length
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: setup
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}
          tailscale_oauth_client_id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          tailscale_oauth_secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          bastion_flavor: "v3-standard-2"
          bastion_image: "Ubuntu 22.04.5 LTS (x86_64) [2025-03-27]"
          debug_mode: "false"

      - name: Build Packer Image
        id: build
        uses: askb/packer-build-action@main
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          mode: build
          packer_template: "packer/templates/robot.pkr.hcl"
          packer_vars_file: "packer/common-packer/vars/${{ matrix.platform }}.pkrvars.hcl"
          packer_working_dir: "packer"
          packer_version: "1.9.1"
          path_prefix: "${{ github.workspace }}"
          bastion_ip: ${{ steps.bastion-setup.outputs.bastion_ip }}
          bastion_ssh_user: "ubuntu"
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}

      - name: Teardown OpenStack Bastion
        if: always()
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: teardown
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}


  build-helm:
    needs: [detect-changes, build-robot]
    if: |
      always() &&
      needs.detect-changes.outputs.helm_platforms != '[]' &&
      (needs.detect-changes.outputs.helm_changed == 'true' ||
       needs.detect-changes.outputs.build_mode == 'scheduled' ||
       needs.detect-changes.outputs.build_mode == 'manual')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: ${{ needs.detect-changes.outputs.build_mode == 'scheduled' && 2 || 5 }}
      matrix:
        platform: ${{ fromJson(needs.detect-changes.outputs.helm_platforms) }}
    steps:
      - name: Checkout change
        if: github.event_name != 'schedule'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/checkout-gerrit-change-action@54d751e8bd167bc91f7d665dabe33fae87aaaa63 # v0.9
        with:
          gerrit-refspec: ${{ inputs.GERRIT_REFSPEC }}
          delay: "0s"
          submodules: "true"

      - name: Checkout repository (scheduled)
        if: github.event_name == 'schedule'
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.repository.default_branch }}
          submodules: true

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Setup OpenStack + Tailscale Bastion
        id: bastion-setup
        # yamllint disable-line rule:line-length
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: setup
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}
          tailscale_oauth_client_id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          tailscale_oauth_secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          bastion_flavor: "v3-standard-2"
          bastion_image: "Ubuntu 22.04.5 LTS (x86_64) [2025-03-27]"
          debug_mode: "false"

      - name: Build Packer Image
        id: build
        uses: askb/packer-build-action@main
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          mode: build
          packer_template: "packer/templates/helm.pkr.hcl"
          packer_vars_file: "packer/common-packer/vars/${{ matrix.platform }}.pkrvars.hcl"
          packer_working_dir: "packer"
          packer_version: "1.9.1"
          path_prefix: "${{ github.workspace }}"
          bastion_ip: ${{ steps.bastion-setup.outputs.bastion_ip }}
          bastion_ssh_user: "ubuntu"
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}

      - name: Teardown OpenStack Bastion
        if: always()
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: teardown
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}

  build-mininet:
    needs: [detect-changes, build-helm]
    if: |
      always() &&
      needs.detect-changes.outputs.mininet_platforms != '[]' &&
      (needs.detect-changes.outputs.mininet_changed == 'true' ||
       needs.detect-changes.outputs.build_mode == 'scheduled' ||
       needs.detect-changes.outputs.build_mode == 'manual')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: ${{ needs.detect-changes.outputs.build_mode == 'scheduled' && 2 || 5 }}
      matrix:
        platform: ${{ fromJson(needs.detect-changes.outputs.mininet_platforms) }}
    steps:
      - name: Checkout change
        if: github.event_name != 'schedule'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/checkout-gerrit-change-action@54d751e8bd167bc91f7d665dabe33fae87aaaa63 # v0.9
        with:
          gerrit-refspec: ${{ inputs.GERRIT_REFSPEC }}
          delay: "0s"
          submodules: "true"

      - name: Checkout repository (scheduled)
        if: github.event_name == 'schedule'
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.repository.default_branch }}
          submodules: true

      - name: Update submodules
        run: git submodule update --init --recursive

      - name: Setup OpenStack + Tailscale Bastion
        id: bastion-setup
        # yamllint disable-line rule:line-length
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: setup
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}
          tailscale_oauth_client_id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          tailscale_oauth_secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          bastion_flavor: "v3-standard-2"
          bastion_image: "Ubuntu 22.04.5 LTS (x86_64) [2025-03-27]"
          debug_mode: "false"

      - name: Build Packer Image
        id: build
        uses: askb/packer-build-action@main
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          mode: build
          packer_template: "packer/templates/mininet-ovs-217.pkr.hcl"
          packer_vars_file: "packer/common-packer/vars/${{ matrix.platform }}.pkrvars.hcl"
          packer_working_dir: "packer"
          packer_version: "1.9.1"
          path_prefix: "${{ github.workspace }}"
          bastion_ip: ${{ steps.bastion-setup.outputs.bastion_ip }}
          bastion_ssh_user: "ubuntu"
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}
          openstack_network_id: ${{ secrets.OPENSTACK_NETWORK_ID }}

      - name: Teardown OpenStack Bastion
        if: always()
        uses: askb/tailscale-openstack-bastion-action@main
        with:
          operation: teardown
          openstack_auth_url: ${{ secrets.OPENSTACK_AUTH_URL }}
          openstack_project_id: ${{ secrets.OPENSTACK_PROJECT_ID }}
          openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          openstack_password: ${{ secrets.OPENSTACK_PASSWORD_B64 }}
          openstack_region: ${{ secrets.OPENSTACK_REGION }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Voting and Summary Jobs
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  vote:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-builder, build-docker, build-robot, build-helm, build-mininet]
    if: |
      always() &&
      github.event_name != 'schedule' &&
      inputs.GERRIT_CHANGE_NUMBER != '' &&
      inputs.GERRIT_CHANGE_NUMBER != '0'
    steps:
      - name: Determine vote
        id: vote-result
        run: |
          # Aggregate results from all build jobs
          builder_result="${{ needs.build-builder.result }}"
          docker_result="${{ needs.build-docker.result }}"
          robot_result="${{ needs.build-robot.result }}"
          helm_result="${{ needs.build-helm.result }}"
          mininet_result="${{ needs.build-mininet.result }}"

          echo "Build results:"
          echo "  Builder: $builder_result"
          echo "  Docker: $docker_result"
          echo "  Robot: $robot_result"
          echo "  Helm: $helm_result"
          echo "  Mininet: $mininet_result"

          # Check if any build failed
          if [[ "$builder_result" == "failure" ]] || \
             [[ "$docker_result" == "failure" ]] || \
             [[ "$robot_result" == "failure" ]] || \
             [[ "$helm_result" == "failure" ]] || \
             [[ "$mininet_result" == "failure" ]]; then
            echo "vote=-1" >> "$GITHUB_OUTPUT"
            echo "message=Packer builds failed" >> "$GITHUB_OUTPUT"
          else
            echo "vote=1" >> "$GITHUB_OUTPUT"
            echo "message=Packer builds successful" >> "$GITHUB_OUTPUT"
          fi

      - name: Submit vote
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/gerrit-review-action@6d2e00dfd3173cd9a36d11350c8fba44731c7b4e # v0.10.0
        with:
          host: ${{ vars.GERRIT_SERVER }}
          username: ${{ vars.GERRIT_SSH_USER }}
          key: ${{ secrets.GERRIT_SSH_PRIVKEY_B64 }}
          known_hosts: ${{ vars.GERRIT_KNOWN_HOSTS }}
          change-number: ${{ inputs.GERRIT_CHANGE_NUMBER }}
          gerrit-label: Verified
          score: ${{ steps.vote-result.outputs.vote }}
          comment-message: ${{ steps.vote-result.outputs.message }}

  build-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-builder, build-docker, build-robot, build-helm, build-mininet]
    if: always()
    steps:
      - name: Generate build summary
        run: |
          {
            echo "# Packer Build Summary"
            echo ""
            trigger="${{ github.event_name == 'schedule' && 'Monthly Scheduled Build' || 'Gerrit Merge Event' }}"
            echo "**Trigger**: $trigger"
            echo "**Build Mode**: ${{ needs.detect-changes.outputs.build_mode }}"
            echo ""
            echo "## Build Results"
            echo ""
            echo "| Builder Type | Status | Platforms Built |"
            echo "|-------------|--------|-----------------|"

            builder_count=$(echo '${{ needs.detect-changes.outputs.builder_platforms }}' | jq 'length')
            docker_count=$(echo '${{ needs.detect-changes.outputs.docker_platforms }}' | jq 'length')
            robot_count=$(echo '${{ needs.detect-changes.outputs.robot_platforms }}' | jq 'length')
            helm_count=$(echo '${{ needs.detect-changes.outputs.helm_platforms }}' | jq 'length')
            mininet_count=$(echo '${{ needs.detect-changes.outputs.mininet_platforms }}' | jq 'length')

            echo "| Builder | ${{ needs.build-builder.result || 'skipped' }} | $builder_count |"
            echo "| Docker | ${{ needs.build-docker.result || 'skipped' }} | $docker_count |"
            echo "| Robot | ${{ needs.build-robot.result || 'skipped' }} | $robot_count |"
            echo "| Helm | ${{ needs.build-helm.result || 'skipped' }} | $helm_count |"
            echo "| Mininet | ${{ needs.build-mininet.result || 'skipped' }} | $mininet_count |"

            total=$((builder_count + docker_count + robot_count + helm_count + mininet_count))
            echo ""
            echo "**Total Images Built**: $total"

            if [[ "${{ github.event_name }}" != "schedule" ]]; then
              echo ""
              echo "---"
              echo "- Change Number: ${{ inputs.GERRIT_CHANGE_NUMBER || 'N/A' }}"
              echo "- Change URL: ${{ inputs.GERRIT_CHANGE_URL || 'N/A' }}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
