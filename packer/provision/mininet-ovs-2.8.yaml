---
- import_playbook: ../common-packer/provision/baseline.yaml

- hosts: all
  become_user: root
  become_method: sudo

  pre_tasks:
    - include_role: name=lfit.system-update

  tasks:
    - name: Install OpenVSwitch
      apt: name=openvswitch-switch state=present
      become: true

    - name: Install Mininet
      apt: name=mininet state=present
      become: true

    - name: Install mtcbench
      block:
        - name: Install mtcbench dependencies
          apt:
            name:
              - autoconf
              - automake
              - build-essential
              - libconfig-dev
              - libffi-dev
              - libpcap-dev
              - libsnmp-dev
              - libtool
              - libssl-doc
              - make
              - pkg-config
              - snmp
              - snmpd
            state: present
          become: true
        - name: Fetch mtcbench git repo
          git:
            repo: https://github.com/intracom-telecom-sdn/mtcbench.git
            dest: /tmp/mtcbench
        - name: Run mtcbench/deploy/docker/provision.sh
          command: /tmp/mtcbench/deploy/docker/provision.sh
          become: true
        - name: Build mtcbench
          # TODO: remove workaround for build issue with mtcbench
          # when mtcbench dependency build correctly
          # https://github.com/intracom-telecom-sdn/mtcbench/issues/10
          shell: /tmp/mtcbench/build_mtcbench.sh || true
        - name: Run make for cbench
          command: make
          args:
            chdir: /tmp/mtcbench/oflops/cbench
        - name: Install cbench to /usr/local/bin/cbench
          copy:
            src: /tmp/mtcbench/oflops/cbench/cbench
            dest: /usr/local/bin/cbench
            mode: 0755
            owner: root
            remote_src: true
          become: true

    - name: Install exabgp
      apt: name=exabgp state=present
      become: true

    - name: Install python-netaddr for custom mininet topologies
      apt: name=python-netaddr state=present
      become: true

    - name: Install vlan for vlan based tests in VTN suites
      apt: name=vlan state=present
      become: true

    - name: Install CSIT dependencies
      apt:
        name:
          - git-review
          - python-chardet
          - python-ndg-httpsclient
          - python-requests
          - python-urllib3
        state: present
      become: true

  post_tasks:
    - name: System Reseal
      script: ../common-packer/provision/system-reseal.sh
      become: true
